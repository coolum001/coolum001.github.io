<!DOCTYPE html>
<html lang="english">
<head>

    <meta charset="utf-8">
    <title>Using GeoPandas to Display Data in Spatial Context - net-analysis.com Data Analysis Blog</title>
    <meta name="description" content="">
    <meta name="author" content="Don Cameron">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="./theme/html5.js"></script>
    <![endif]-->


    <!-- Le styles -->
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="./theme/local.css" rel="stylesheet">
    <link href="./theme/pygments.css" rel="stylesheet">
    <link href="./theme/font-awesome.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Gudea:400,400italic|Alegreya+SC' rel='stylesheet' type='text/css'>

</head>

<body>
<header class="blog-header">
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
	<a href="." class="brand">net-analysis.com Data Analysis Blog</a>
      </div>

      <div class="span3" id="blog-nav">
	<ul class="nav nav-pills pull-right">
	    <li >
	      <a href="./category/basemap.html ">Basemap</a>
	    <li >
	      <a href="./category/cartopy.html ">Cartopy</a>
	    <li  class="active" >
	      <a href="./category/geopandas.html ">GeoPandas</a>
	    <li >
	      <a href="./category/introduction.html ">Introduction</a>
	    <li >
	      <a href="./category/landsat.html ">LANDSAT</a>
	    <li >
	      <a href="./category/visualizations.html ">Visualizations</a>
	</ul>
      </div>
    </div> <!-- End of fluid row-->
  </div>   <!-- End of Container-->
</header>
    
<div class="container">
    <div class="content">
    <div class="row-fluid">

        <div class="span10">
    <div class='article'>
      <div class="row-fluid">
           <div class="content-title span9">
             <h1>Using GeoPandas to Display Data in Spatial Context</h1>
           </div>
      </div>
    <div class="row-fluid">
      <div class="span2">
<p>Sun 22 July 2018 </p>

<p style="text-align: left;">
Filed under <a href="./category/geopandas.html">GeoPandas</a>
</p>
<p style="text-align: left;">
 
    Tags <a href="./tag/geopandas.html">geopandas</a> <a href="./tag/python.html">python</a> <a href="./tag/colorbar.html">colorbar</a> <a href="./tag/projections.html">projections</a> <a href="./tag/cartopy.html">cartopy</a> </p>
<p>
</p>
      </div>
      
      <div class="span8">
	<h1>GeoPanda and Data Display</h1>
<h2>Introduction</h2>
<p>This is a short note to provide some examples of creating maps, with associated display of data.  </p>
<p>Some of the complexity comes from the use of map projections.  If we use Cartopy, then we get support for different map projections out-of-box.</p>
<h3>Cartopy Example</h3>
<p>For example, if we run the code below, we can see that Cartopy has stretched the <code>stock_img</code>, and the gridlines to accomodate the Mercator projection.</p>
<div class="highlight"><pre><span></span>fig = plt.figure(figsize=(8, 8))
ax = fig.add_subplot(1, 1, 1, projection=ccrs.Mercator())

# make the map global rather than have it zoom in to
# the extents of any plotted data
ax.set_extent([110, 160, -45, -10])

ax.stock_img()
ax.coastlines()

gl = ax.gridlines(draw_labels=True, crs=ccrs.PlateCarree() )
gl.xformatter = LONGITUDE_FORMATTER
gl.yformatter = LATITUDE_FORMATTER

plt.show()
</pre></div>


<p><img alt="Cartopy Mercator Map" src="./images/geopandasdata01.png"></p>
<h2>GeoPandas Example</h2>
<h3>using PlateCarree</h3>
<p>As an example, we are going to use the Geopandas <code>naturalearth_lowres</code> dataset, place a marker at the centre of each country, and draw a bounding box around Australia.</p>
<p>The code looks like:</p>
<div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 12))
ax = fig.add_subplot(1, 1, 1, projection=ccrs.PlateCarree())

path=gpd.datasets.get_path(&#39;naturalearth_lowres&#39;)

world = gpd.read_file(path)
print(world.crs)

box_oz = world[world[&#39;name&#39;]==&#39;Australia&#39;].copy().envelope

world.plot(ax=ax)
box_oz.plot(ax=ax, edgecolor=&#39;red&#39;, facecolor=&#39;none&#39;)
world.centroid.plot(ax=ax, color=&#39;red&#39;)

plt.show()
</pre></div>


<p>This gives us:</p>
<p><img alt="Spatial Markers Map" src="./images/geopandasdata02.png"></p>
<p>Note that the printout of the dataset Coordinate Reference System (CRS) gives us <code>{'init': 'epsg:4326'}</code>;  i.e., it is our old friend PlateCarree (the projection we have chosen for the whole map.</p>
<h3>Using Mollweide</h3>
<p>If we wish to use a different projection for the map, we must use the Geopands <code>to_crs()</code> method, to convert the geometery attributes to the new projection coordinates.</p>
<p>The code looks like:</p>
<div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 12))

mol = ccrs.Mollweide()
ax = fig.add_subplot(1, 1, 1, projection=mol)

path=gpd.datasets.get_path(&#39;naturalearth_lowres&#39;)

world = gpd.read_file(path)
print(world.crs)

world_mol = world.to_crs(mol.proj4_init)

box_oz = world[world[&#39;name&#39;]==&#39;Australia&#39;].copy().envelope
box_oz_mol = box_oz.to_crs(mol.proj4_init)

world_mol.plot(ax=ax)
box_oz_mol.plot(ax=ax, edgecolor=&#39;red&#39;, facecolor=&#39;none&#39;,  )
world_mol.centroid.plot(ax=ax, color=&#39;red&#39;)

plt.show()
</pre></div>


<p>This gives us:</p>
<p><img alt="Spatial Markers Mollweide Map" src="./images/geopandasdata03.png"></p>
<p>We can see that the centroids of the countries have been translated to the correct places, but sadly, the bounding box for Australia is wrong!  This is because the <code>box_oz_mol.plot()</code> method we used, asks for straight lines in the Mollweide projection (which is not what we want).</p>
<p>We can fix this by get the latitude, longitude pairs for the corners of the box, and asking Cartopy to draw great circle by use of the <code>transform=ccrs.Geodetic()</code> parameter to the <code>plot()</code> call.</p>
<p>The code looks like:</p>
<div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 12))

# specify a non-PlateCarree projection for map Axes
mol = ccrs.Mollweide()
ax = fig.add_subplot(1, 1, 1, projection=mol)

# read the datset we wish to display
path=gpd.datasets.get_path(&#39;naturalearth_lowres&#39;)

world = gpd.read_file(path)
print(world.crs)

# get the lat, lons of the Australia bounding box
box_oz = world[world[&#39;name&#39;]==&#39;Australia&#39;].copy().envelope
for t in box_oz.exterior:
    corners = list(t.coords)
    c_x = [xy[0] for xy in corners]
    c_y = [xy[1] for xy in corners]
#end for

# convert the dataset to the Projection we have chosen
world_mol = world.to_crs(mol.proj4_init)

# plot the dataset, using GeoPandas plot command
world_mol.plot(ax=ax)

# Plot the bounding box, asking Matplotlib / Cartopy to use Great Circles for the bounding box lines
plt.plot(c_x, c_y,  linewidth=2, transform=ccrs.Geodetic() , color=&#39;green&#39;)
world_mol.centroid.plot(ax=ax, color=&#39;red&#39;)

plt.show()
</pre></div>


<p>This gives us the following map, where indeed the green bounding box just touches Australia.</p>
<p><img alt="Correct Lines on Mollweide Map" src="./images/geopandasdata04.png"></p>
<h2>Markers with Meaning</h2>
<h3>Default Projection</h3>
<p>Now we move on to making the markers carry more information than just their location.<br>
Suppose we want to display GDP for each country. 
The code below will achieve this is shown below.<br>
One caveat: the whole concept of encoding a value into a circle is a little contentious - should the radius or the area be proportional to the value? I have chosen to encode the radius.  I have used the GeoPandas <code>iterrows()</code> method to access each row (country) of the GeoPandas dataframe one by one, zipped up with the geometric centroid of each country.</p>
<div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 12))
ax = fig.add_subplot(1, 1, 1, projection=ccrs.PlateCarree())

path=gpd.datasets.get_path(&#39;naturalearth_lowres&#39;)

world = gpd.read_file(path)
gdp_max = world[&#39;gdp_md_est&#39;].max()
gdp_min = world[&#39;gdp_md_est&#39;].min()

world.plot(ax=ax, facecolor=&#39;lightgrey&#39;, edgecolor=&#39;grey&#39;, )

max_size = 40
min_size = 1

#world.centroid.plot(ax=ax, color=&#39;red&#39;)
for (idx, country), cd in zip(world.iterrows(), world.centroid):

    gdp = country[&#39;gdp_md_est&#39;]
    plt.plot(cd.xy[0], cd.xy[1], 
             marker=&#39;o&#39;, 
             color=&#39;red&#39;, 
             markersize=min_size+(max_size-min_size)*(gdp/gdp_max), 
             transform=ccrs.Geodetic(),
            alpha=0.75,
            )

#end for
plt.show()
</pre></div>


<p>This gives us:</p>
<p><img alt="Data Markers on PlateCarree" src="./images/geopandasdata05.png"></p>
<h3>Mollweide Projection</h3>
<p>If we want to display the same data, but on the Mollweide Projection, then the code looks very similar.  We read the dataset, and convert the geometery to coordinates in the desired projection by <code>world_mol = world.to_crs(mol.proj4_init)</code>.</p>
<p>We then use GeoPandas to plot the map outlines by <code>world_mol.plot(ax=ax)</code>.</p>
<p>We then plot the markers via Matplotlib / Cartopy, getting the original lat/lon values, and asking Cartopy to transform these from a Geodetic projection, to the current map projection.</p>
<div class="highlight"><pre><span></span># set range of marker size
max_size = 40
min_size = 1
for (idx, country), cd in zip(world.iterrows(), world.centroid):
    gdp = country[&#39;gdp_md_est&#39;]
    plt.plot(cd.xy[0], cd.xy[1], 
             marker=&#39;o&#39;, 
             color=&#39;red&#39;, 
             markersize=min_size+(max_size-min_size)*(gdp/gdp_max), 
             transform=ccrs.Geodetic(),
            alpha=0.75,
            )

#end for
</pre></div>


<p><img alt="Data Markers on Mollweide" src="./images/geopandasdata06.png"></p>
<h2>GeoPandas Continuous Shading and Discrete Markers</h2>
<p>GeoPandas comes with capability to display data in spatial context, by the color of the polygons it plots.  We can combine this with our markers, as below:</p>
<p>First, we define our figure, and get a Cartopy-aware Axes object.</p>
<div class="highlight"><pre><span></span>fig = plt.figure(figsize=(20, 20))
ax = fig.add_subplot(1, 1, 1, projection=ccrs.PlateCarree())

# set aspect to equal. This is done automatically
# when using *geopandas* plot on it&#39;s own, but not when
# working with pyplot directly.
ax.set_aspect(&#39;equal&#39;)
</pre></div>


<p>Then we load our dataset.</p>
<div class="highlight"><pre><span></span>path=gpd.datasets.get_path(&#39;naturalearth_lowres&#39;)

world = gpd.read_file(path)
gdp_max = world[&#39;gdp_md_est&#39;].max()
gdp_min = world[&#39;gdp_md_est&#39;].min()
</pre></div>


<p>Then we tell GeoPandas to plot the country polygons, coloring each one according to the estimated population (the <code>pop_est</code> column of our dataframe).</p>
<div class="highlight"><pre><span></span>p = world.plot(ax=ax, facecolor=&#39;lightgrey&#39;, edgecolor=&#39;grey&#39;, column=&#39;pop_est&#39;, 
           legend=True,
          )
</pre></div>


<p>Then we define our marker sizes, and for each row (country) in our dataframe, get the longtitude / latitude of the geometric centroid, and get the GDP (estimated).  We then place a marker at that position, sized according to the GDP value.</p>
<div class="highlight"><pre><span></span>max_size = 40
min_size = 1


for (idx, country), cd in zip(world.iterrows(), world.centroid):

    gdp = country[&#39;gdp_md_est&#39;]
    plt.plot(cd.xy[0], cd.xy[1], 
             marker=&#39;o&#39;, 
             color=&#39;red&#39;, 
             markersize=min_size+(max_size-min_size)*(gdp/gdp_max), 
             transform=ccrs.Geodetic(),
            alpha=0.75,
            )

#end for
</pre></div>


<p>Now for some hackery:  GeoPandas defaults to a color bar that runs from near the bottom of the figure to near the top, embedded in its own Axes object.  Because we have a map projection that is twice as wide as high (360 degrees vs 180 degrees), 
and because we have asked for a square figure <code>fig = plt.figure(figsize=(20, 20))</code>
this gives us whitespace above and below the map.  The color bar is out of proportion.</p>
<p>So we get the Axes objects for map and legend (colorbar), and force the color bar Axes to be the same height as the map Axes.</p>
<p>Then we set a title in each axis, and show the result.</p>
<div class="highlight"><pre><span></span>map_ax = fig.axes[0]
leg_ax = fig.axes[1]

map_box = map_ax.get_position()
leg_box = leg_ax.get_position()

leg_ax.set_position([leg_box.x0, map_box.y0, leg_box.width, map_box.height])

leg_ax.set_title(&#39;Population&#39;, pad=40)
map_ax.set_title(&#39;Country GDP&#39;, pad=50)

plt.show()
</pre></div>


<p>This gives us:</p>
<p><img alt="Combined Data Visualization" src="./images/geopandasdata07.png"></p>
<h2>Imports</h2>
<p>Just for completeness, here are the imports from the Notebook that contains the code above
(some are used only to support print-outs that define the environment for reproducibility purposes) </p>
<div class="highlight"><pre><span></span><span class="c1"># all imports should go here</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="kn">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">cartopy.mpl.gridliner</span> <span class="kn">import</span> <span class="n">LONGITUDE_FORMATTER</span><span class="p">,</span> <span class="n">LATITUDE_FORMATTER</span>

<span class="kn">import</span> <span class="nn">geopandas</span> <span class="kn">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</pre></div>


<p>The link to the Notebook that has all the code is coming soon.</p>
	<hr />
      </div>
    </div>
    <div class="span10">
      <h3>Comments</h3>
    
    </div>  
    </div>
        </div>
        
        
    </div>     </div> </div>

<!--footer-->
<div class="container">
  <div class="well" style="background-color: #E9EFF6">
    <div id="blog-footer">
      <div class="row-fluid">
	<div class="social span2" align="center" id="socialist">
	  <ul class="nav nav-list">
	    <li class="nav-header">
	      Social
	    </li>
	    <li><a href="https://www.linkedin.com/in/donrcameron/"><i class="icon-Linkedin Page" style="color: #1f334b"></i>Linkedin Page</a></li>
	    <li><a href="https://www.flickr.com/photos/donrcameron/"><i class="icon-flickr Page" style="color: #1f334b"></i>flickr Page</a></li>
            <a href="mailto:donrcameron@gmail.com"><i class="icon-envelope" style="color: #1f334b" ></i> email</a>

	  </ul>
	</div>
<div class="span8" id="colophon">
  <h2 align="center">About</h2>
  <p align="justify"> 

This series of blog posts is provided as a resource by 

net-analysis.com - PO Box 857, Coolum Beach, QLD 4573, AUSTRALIA. ABN 19469649963.

Ring 0413 208 746, or visit the company website:

http://www.net-analysis.com.   It documents a learning process, and hence owes a debt of gratitude to all the people who have documented their own experiences on the web: the list is too large to enumerate.
 </p>
</div>
        <div class="links span2" align="center">
          <ul class="nav nav-list">
            <li class="nav-header"> 
              Links
            </li>
            
            <li><a href="http://getpelican.com/">Pelican</a></li>
            <li><a href="http://python.org/">Python.org</a></li>
          </ul>
        </div>
	<div class="site-nav span2" align="center">
          <ul class="nav nav-list" id="site-links">
            <li class="nav-header"> 
              Site
            </li>
            <li><a href="."><i class="icon-home" style="color: #1f334b">
                </i>Home</a></li>
            <li><a href="./archives.html"><i class="icon-list" style="color: #1f334b">
                </i>Archives</a></li>
	    <li><a href="./tags.html"><i class="icon-tags" style="color: #1f334b">
                </i>Tags</a></li>
	    
	  </ul>

        </div>

      </div> <!--end of fluid row-->
    </div> <!--end of blog-footer-->
    <hr />
    <p align="center"><a href=".">net-analysis.com Data Analysis Blog</a>
      &copy; Don Cameron
    Powered by <a href="https://github.com/getpelican/pelican">Pelican</a> and
        <a href="https://twitter.github.com/bootstrap">Twitter Bootstrap</a>. 
        Icons by <a href="https://fortawesome.github.com/Font-Awesome">Font Awesome</a> and 
        <a href="https://gregoryloucas.github.com/Font-Awesome-More">Font Awesome More</a></p>

  </div> <!--end of well -->
</div> <!--end of container -->

<!--/footer-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>



</body>
</html>